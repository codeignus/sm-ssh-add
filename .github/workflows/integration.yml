name: Integration Tests

on:
  pull_request:
    branches: [main]

jobs:
  integration-vault:
    name: Integration Tests (Vault)
    runs-on: ubuntu-latest

    services:
      vault:
        image: hashicorp/vault:latest
        ports:
          - 8200:8200
        env:
          VAULT_DEV_ROOT_TOKEN_ID: test-token
          VAULT_DEV_LISTEN_ADDRESS: 0.0.0.0:8200
        options: >-
          --cap-add=IPC_LOCK

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Wait for Vault
        run: |
          for i in {1..30}; do
            if curl -s http://localhost:8200/v1/sys/health > /dev/null; then
              echo "Vault is ready"
              break
            fi
            echo "Waiting for Vault... ($i/30)"
            sleep 2
          done

      - name: Run integration tests
        env:
          VAULT_ADDR: http://localhost:8200
          VAULT_TOKEN: test-token
        run: |
          go test -v -tags=integration ./internal/sm/

  integration-openbao:
    name: Integration Tests (OpenBao)
    runs-on: ubuntu-latest

    services:
      openbao:
        image: openbao/openbao:latest
        ports:
          - 8200:8200
        env:
          BAO_DEV_ROOT_TOKEN_ID: test-token
          BAO_DEV_LISTEN_ADDRESS: 0.0.0.0:8200
        options: >-
          --cap-add=IPC_LOCK

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Wait for OpenBao
        run: |
          for i in {1..30}; do
            if curl -s http://localhost:8200/v1/sys/health > /dev/null; then
              echo "OpenBao is ready"
              break
            fi
            echo "Waiting for OpenBao... ($i/30)"
            sleep 2
          done

      - name: Run integration tests
        env:
          BAO_ADDR: http://localhost:8200
          BAO_TOKEN: test-token
        run: |
          go test -v -tags=integration ./internal/sm/

  integration-agent:
    name: Integration Tests (ssh-agent)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Start ssh-agent
        run: |
          eval "$(ssh-agent -s)"
          echo "SSH_AUTH_SOCK=$SSH_AUTH_SOCK" >> $GITHUB_ENV

      - name: Run integration tests
        run: |
          go test -v -tags=integration ./internal/ssh/
