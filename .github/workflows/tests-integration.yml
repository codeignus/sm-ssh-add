name: Integration Tests

on:
  pull_request:
    branches: [main]

jobs:
  integration-vault-compatible:
    name: Integration Tests (${{ matrix.provider }})
    runs-on: ubuntu-latest

    # Vault and OpenBao are API-compatible, so we use a matrix to avoid duplication
    # Future providers (AWS, Azure, etc.) will need separate jobs
    strategy:
      matrix:
        include:
          - provider: Vault
            image: hashicorp/vault:latest
            addr_env: VAULT_ADDR
            token_env: VAULT_TOKEN
            service_env_prefix: VAULT
          - provider: OpenBao
            image: openbao/openbao:latest
            addr_env: BAO_ADDR
            token_env: BAO_TOKEN
            service_env_prefix: BAO

    services:
      vault-compatible:
        image: ${{ matrix.image }}
        ports:
          - 8200:8200
        env:
          ${{ format('{0}_DEV_ROOT_TOKEN_ID', matrix.service_env_prefix) }}: test-token
          ${{ format('{0}_DEV_LISTEN_ADDRESS', matrix.service_env_prefix) }}: 0.0.0.0:8200
        options: >-
          --cap-add=IPC_LOCK

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.25.5"

      - name: Wait for ${{ matrix.provider }}
        run: |
          for i in {1..30}; do
            if curl -s http://localhost:8200/v1/sys/health > /dev/null; then
              echo "${{ matrix.provider }} is ready"
              break
            fi
            echo "Waiting for ${{ matrix.provider }}... ($i/30)"
            sleep 2
          done

      - name: Setup AppRole (Vault only)
        if: matrix.provider == 'Vault'
        env:
          VAULT_ADDR: http://localhost:8200
          VAULT_TOKEN: test-token
        run: |
          # Install jq for JSON parsing
          sudo apt-get update && sudo apt-get install -y curl jq

          # Enable AppRole auth method via Vault API (idempotent - safe if already enabled)
          curl -s -X POST $VAULT_ADDR/v1/sys/auth/approle -H "X-Vault-Token: $VAULT_TOKEN" -d '{"type": "approle"}' || true

          # Create policy via Vault API (idempotent - will overwrite if exists)
          curl -s -X POST $VAULT_ADDR/v1/sys/policies/acl/sm-ssh-add-policy \
            -H "X-Vault-Token: $VAULT_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{
              "policy": "path \"secret/data/ssh/*\" {\n  capabilities = [\"create\", \"read\", \"update\", \"delete\", \"list\"]\n}\npath \"secret/metadata/ssh/*\" {\n  capabilities = [\"list\"]\n}"
            }'

          # Create AppRole with policy via Vault API (idempotent - will overwrite if exists)
          curl -s -X POST $VAULT_ADDR/v1/auth/approle/role/sm-ssh-add \
            -H "X-Vault-Token: $VAULT_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"token_policies": "sm-ssh-add-policy", "token_ttl": "1h"}'

          # Get role_id and secret_id via Vault API
          ROLE_ID=$(curl -s -X GET $VAULT_ADDR/v1/auth/approle/role/sm-ssh-add/role-id -H "X-Vault-Token: $VAULT_TOKEN" | jq -r '.data.role_id')
          SECRET_ID=$(curl -s -X POST $VAULT_ADDR/v1/auth/approle/role/sm-ssh-add/secret-id -H "X-Vault-Token: $VAULT_TOKEN" | jq -r '.data.secret_id')

          echo "VAULT_APPROLE_ROLE_ID=$ROLE_ID" >> $GITHUB_ENV
          echo "VAULT_APPROLE_SECRET_ID=$SECRET_ID" >> $GITHUB_ENV

      - name: Run integration tests
        env:
          ${{ matrix.addr_env }}: http://localhost:8200
          ${{ matrix.token_env }}: test-token
        run: |
          go test -v -tags=integration ./internal/sm/ ./cmd/

  integration-ssh-agent:
    name: Integration Tests (ssh-agent)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.25.5"

      - name: Start ssh-agent
        run: |
          eval "$(ssh-agent -s)"
          echo "SSH_AUTH_SOCK=$SSH_AUTH_SOCK" >> $GITHUB_ENV

      - name: Run integration tests
        run: |
          go test -v -tags=integration ./internal/ssh/

  e2e-cli:
    name: End-to-End CLI Tests (${{ matrix.provider }})
    runs-on: ubuntu-latest

    # Vault and OpenBao are API-compatible, so we use a matrix to avoid duplication
    # Future providers (AWS, Azure, etc.) will need separate jobs
    strategy:
      matrix:
        include:
          - provider: vault
            image: hashicorp/vault:latest
            addr_env: VAULT_ADDR
            token_env: VAULT_TOKEN
            service_env_prefix: VAULT
          - provider: openbao
            image: openbao/openbao:latest
            addr_env: BAO_ADDR
            token_env: BAO_TOKEN
            service_env_prefix: BAO

    services:
      vault-compatible:
        image: ${{ matrix.image }}
        ports:
          - 8200:8200
        env:
          ${{ format('{0}_DEV_ROOT_TOKEN_ID', matrix.service_env_prefix) }}: test-token
          ${{ format('{0}_DEV_LISTEN_ADDRESS', matrix.service_env_prefix) }}: 0.0.0.0:8200
        options: >-
          --cap-add=IPC_LOCK

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.25.5"

      - name: Wait for ${{ matrix.provider }}
        run: |
          for i in {1..30}; do
            if curl -s http://localhost:8200/v1/sys/health > /dev/null; then
              echo "${{ matrix.provider }} is ready"
              break
            fi
            echo "Waiting for ${{ matrix.provider }}... ($i/30)"
            sleep 2
          done

      - name: Start ssh-agent
        run: |
          eval "$(ssh-agent -s)"
          echo "SSH_AUTH_SOCK=$SSH_AUTH_SOCK" >> $GITHUB_ENV

      - name: Run E2E tests
        env:
          ${{ matrix.addr_env }}: http://localhost:8200
          ${{ matrix.token_env }}: test-token
        run: |
          ./cmd/test-e2e.sh ${{ matrix.provider }}
